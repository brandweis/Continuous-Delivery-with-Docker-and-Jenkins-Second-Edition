stage('Build') {
  steps {
    dir('Chapter08/sample1') {
      sh './gradlew clean build'
    }
  }
}

stage('Unit Tests') {
  when {
    anyOf {
      branch 'master'
      branch 'feature'
      branch 'playground'
    }
  }
  steps {
    dir('Chapter08/sample1') {
      sh './gradlew test'
    }
  }
}

stage('Code Coverage') {
  when {
    branch 'master'
  }
  steps {
    dir('Chapter08/sample1') {
      sh './gradlew jacocoTestReport jacocoTestCoverageVerification'
    }
  }
}

stage('Build and Push Docker Image') {
  when {
    allOf {
      not { branch 'playground' }
      expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
    }
  }
  steps {
    dir('Chapter08/sample1') {
      script {
        def fullImage = "${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
        sh """
          docker build -t ${fullImage} .
          echo testpassword | docker login https://${REGISTRY} -u testuser --password-stdin
          docker push ${fullImage}
        """
      }
    }
  }
}

